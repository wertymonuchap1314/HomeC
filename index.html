<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HomeC</title>

<style>
body {
  margin: 0;
  font-family: Arial;
}

.header {
  padding: 15px;
  font-size: 22px;
  font-weight: bold;
}

.line {
  height: 1px;
  background: grey;
}

.addBtn {
  text-align: right;
  padding: 10px 15px;
  font-size: 22px;
  cursor: pointer;
}

#searchSection {
  display: none;
  padding: 10px;
}

#searchInput {
  width: 100%;
  padding: 8px;
}

#contacts {
  padding: 10px;
}

#contacts p {
  padding: 12px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
}

/* CHAT SCREEN */
#chatScreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: white;
  display: none;
  flex-direction: column;
}

.chatHeader {
  padding: 10px;
  border-bottom: 1px solid #ccc;
  display: flex;
  align-items: center;
}

.chatHeader h3 {
  margin-left: 10px;
}

#messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.message {
  margin: 5px 0;
  padding: 8px 12px;
  border-radius: 15px;
  max-width: 60%;
}

.sent {
  background: #007bff;
  color: white;
  align-self: flex-end;
}

.received {
  background: #eee;
  align-self: flex-start;
}

.chatInput {
  display: flex;
  padding: 10px;
  border-top: 1px solid #ccc;
}

.chatInput input {
  flex: 1;
  padding: 8px;
}

.chatInput button {
  padding: 8px 12px;
  margin-left: 5px;
}
</style>
</head>

<body>

<div class="header">HomeC</div>
<div class="line"></div>
<div class="addBtn" onclick="toggleSearch()">+</div>

<div id="searchSection">
  <input type="text" id="searchInput" placeholder="Search username">
  <div id="searchResult"></div>
</div>

<div id="contacts"></div>

<!-- CHAT SCREEN -->
<div id="chatScreen">
  <div class="chatHeader">
    <button onclick="closeChat()">â¬…</button>
    <h3 id="chatWith"></h3>
  </div>

  <div id="messages"></div>

  <div class="chatInput">
    <input type="text" id="messageInput" placeholder="Type message">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
let currentUser = localStorage.getItem("loggedInUser");

if (!currentUser) {
  window.location.href = "auth.html";
}

let users = JSON.parse(localStorage.getItem("users")) || [];
let contacts = JSON.parse(localStorage.getItem(currentUser + "_contacts")) || [];
let chattingWith = null;

const searchInput = document.getElementById("searchInput");
const searchResult = document.getElementById("searchResult");
const contactList = document.getElementById("contacts");

function toggleSearch() {
  const section = document.getElementById("searchSection");
  section.style.display = section.style.display === "none" ? "block" : "none";
}

searchInput.addEventListener("input", function() {
  const value = this.value.toLowerCase();
  searchResult.innerHTML = "";

  if (value === "") return;

  users.forEach(user => {
    if (
      user.username.toLowerCase().includes(value) &&
      user.username !== currentUser
    ) {
      searchResult.innerHTML += `
        <p>${user.username} 
        <button onclick="addUser('${user.username}')">Add</button></p>`;
    }
  });
});

function addUser(username) {
  if (!contacts.includes(username)) {
    contacts.push(username);
    localStorage.setItem(currentUser + "_contacts", JSON.stringify(contacts));
    loadContacts();
  }
}

function loadContacts() {
  contactList.innerHTML = "";
  contacts.forEach(name => {
    contactList.innerHTML += `
      <p onclick="openChat('${name}')">${name}</p>
    `;
  });
}

function openChat(username) {
  chattingWith = username;
  document.getElementById("chatWith").innerText = username;
  document.getElementById("chatScreen").style.display = "flex";
  loadMessages();
}

function closeChat() {
  document.getElementById("chatScreen").style.display = "none";
}

function sendMessage() {
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if (text === "") return;

  const key = getChatKey(currentUser, chattingWith);

  let chats = JSON.parse(localStorage.getItem("chats")) || {};
  if (!chats[key]) chats[key] = [];

  chats[key].push({
    sender: currentUser,
    text: text
  });

  localStorage.setItem("chats", JSON.stringify(chats));

  input.value = "";
  loadMessages();
}

function loadMessages() {
  const key = getChatKey(currentUser, chattingWith);
  let chats = JSON.parse(localStorage.getItem("chats")) || {};
  const messagesDiv = document.getElementById("messages");
  messagesDiv.innerHTML = "";

  if (!chats[key]) return;

  chats[key].forEach(msg => {
    const div = document.createElement("div");
    div.classList.add("message");

    if (msg.sender === currentUser) {
      div.classList.add("sent");
    } else {
      div.classList.add("received");
    }

    div.innerText = msg.text;
    messagesDiv.appendChild(div);
  });
}

function getChatKey(user1, user2) {
  return [user1, user2].sort().join("_");
}

loadContacts();
</script>

</body>
</html>